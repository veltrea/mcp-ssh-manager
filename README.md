# mcp-ssh-manager

`mcp-ssh-manager` は、ネットワーク内のSSH接続先を統合管理するGUIハブ兼MCPサーバーです。
本ツールは、純粋なRust実装によるポータブルなSSHクライアントである [**mcp-ssh**](https://github.com/veltrea/mcp-ssh) と対になる存在であり、**この2つが揃うことで初めてAI時代のセキュアなリモート操作が完結します。** 開発の便宜上リポジトリは分かれていますが、これらは一つのエコシステムの両輪として設計されています。

## 🛡️ 設計思想：AI時代のゼロトラストSSH

AIエージェントとSSHを連携させる際、従来のパスワード認証には重大なリスクが伴います。本プロジェクトは、以下の課題を解決するために「パスワードレス・ハードウェア強制」を提唱します。

1. **AIの記憶リスクの回避**: 一度AIに渡したID/パスワードは、その対話履歴に残るだけでなく、モデルの記憶（コンテキスト）から完全に消去することが困難です。これは永続的な情報漏洩リスクとなります。
2. **パスワード情報の隠蔽**: 「パスワードを入力するのは初回の設定時のみ」を徹底します。MCP化したSSHを通じて、AIエージェントにはパスワードやクリティカルな認証情報を一切見せず、安全に抽象化された「エイリアス」のみで操作を完結させます。
3. **TPMによる鍵の保護**: 生成された秘密鍵はデバイス内の **TPM (Trusted Platform Module)** に格納されます。これにより、AIエージェントや悪意のあるソフトウェアが物理的な鍵ファイル（`.ssh/id_rsa`等）に直接触れたり盗み出したりすることを防ぎます。
4. **Windows ACL問題の克服**: WindowsのOpenSSH環境では、頻繁なパスワード変更や鍵ファイルのアクセス権限（ACL）設定ミスが原因で認証エラーが発生しがちです。本ツールのオンボーディング・ウィザードは、これらの複雑な権限設定を自動化し、安定した鍵認証への移行を促進します。

単なる利便性向上ではなく、**「AIに秘密を教えない」** ゼロトラスト環境の構築が本ツールの真の目的です。

## 🌟 核心機能：ハードウェア・アイデンティティ

本ツールは「誰が」接続するかだけでなく、「どのデバイスから」接続するかを厳格に管理します。

- **mcp-ssh の統合管理**: [**mcp-ssh**](https://github.com/veltrea/mcp-ssh) が使用する接続先や資格情報をGUIで一元管理。
- **TPM/Secure Enclave 連携**: デバイスのセキュリティチップ内で秘密鍵を生成・保持。鍵のコピーや持ち出しは不可能です。
- **オンボーディング・ウィザード**: 初回設定時にデバイスの健全性を診断し、ハードウェアに紐付いた識別子をリモートサーバーに安全に登録します。
- **ゼロトラスト・アクセス**: 従来のパスワード認証を廃し、常にデバイスのハードウェア証明を求める構成を推奨します。

## 1. メインインターフェース (タブ構成)

### 1.1. 🌐 接続先 (Connections)
- **ステータス表示**: マシンの左側に表示されるアイコン（🟢 オンライン / 🔴 オフライン）で稼働状況を把握。
- **クイック操作**: 
    - **✏️ 編集**: マシンのスペックや監視ポートの変更。
    - **⚡ WOL**: Wake-On-LANによるマシンの遠隔起動。
    - **💻 接続**: 標準の `ssh` コマンドを介したターミナルの起動。
- **高度な検索**: 用途やホスト名で瞬時にフィルタリング。

### 1.2. 👥 アカウント (Accounts)
- SSH接続に使用する資格情報（ユーザー名、パスワード、秘密鍵）を安全に登録・管理します。

### 1.3. 📜 ログ (Logs)
- すべてのツール実行（`ssh_exec`等）の履歴、コマンド、終了コード、タイムスタンプを確認できます。

### 1.4. 🛠️ ツール (Tools)
- **自動バックアップ**: 毎日1回、SQLiteデータベースのバックアップを自動生成します。
- **バックアップローテーション**: 直近7日分を保持し、古いものは自動削除されます。
- **手動バックアップ**: 任意のタイミングで即座にバックアップを作成可能。

## 2. 高度な機能

### 2.1. 死活監視 (Advanced Monitoring)
- **ICMP Ping**: TCPポートが閉じている場合でも、Pingによる疎通確認を自動で行います。
- **カスタムポート**: SSH(22)以外にも、HTTP(80/443)など任意のポートで監視可能です。

### 2.2. 自動メンテナンス
- アプリケーションが起動している間、バックグラウンドでマシンの稼獲確認とデータベースのバックアップが定期的に行われます。

## 4. コマンドライン (CLI) モード
本アプリはコマンドライン引数を渡すことで、GUIなしでの操作が可能です。

### 4.1. マシン一覧の表示
```bash
cargo run -- list
```

### 4.2. マシンの追加
```bash
cargo run -- add <name> <ip> --purpose "目的" --owner "personal" --os "linux"
```

### 4.3. バックアップの実行
```bash
cargo run -- backup [出力パス]
```

### 4.4. ヘッドレス MCP サーバーモード
GUIを起動せず、MCPサーバーとしてのみ待機します。
```bash
cargo run -- mcp
```

## 5. 設定とパス
- **データベース**: `~/Library/Application Support/com.veltrea.mcp-ssh-manager/manager.db`
- **バックアップ出力先**: 同ディレクトリ内の `backups/` フォルダ。

## 6. MCPサーバーとしての利用
本アプリは標準入出力を介したMCPプロトコルに対応しています。LM Studioや他のAIクライアントから `ssh_exec` や `list_machines` 等のツールを呼び出すことが可能です。
